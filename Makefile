# generated by DipDup 8.3.2
.PHONY: $(MAKECMDGOALS)
MAKEFLAGS += --no-print-directory
##
##  ðŸš§ DipDup developer tools
##
PACKAGE=dex_screener
TAG=latest
COMPOSE=deploy/compose.yaml

help:           ## Show this help (default)
	@grep -Fh "##" $(MAKEFILE_LIST) | grep -Fv grep -F | sed -e 's/\\$$//' | sed -e 's/##//'

all:            ## Run an entire CI pipeline
	make install format lint

##

install:        ## Install dependencies
	uv sync --all-extras --all-groups --link-mode symlink --locked

update:         ## Update dependencies
	dipdup self update -q
	uv sync --all-extras --all-groups --link-mode symlink -U

format:         ## Format code with ruff
	ruff format .

lint:           ## Lint code with ruff and mypy
	ruff check --fix .
	mypy .

##

image:          ## Build Docker image
	docker buildx build . -f deploy/Dockerfile -t ${PACKAGE}:${TAG} --load

# up:             ## Start Compose stacks
# 	PROJECT=hydration docker-compose -p hydration -f ${COMPOSE} --env-file hydration.compose.env up -d --build
# 	PROJECT=assethub docker-compose -p assethub -f ${COMPOSE} --env-file assethub.compose.env up -d --build

# down:           ## Stop Compose stacks
# 	docker-compose -p hydration -f ${COMPOSE} down
# 	docker-compose -p assethub -f ${COMPOSE} down

init:
	dipdup init --no-base
	cd reserves && dipdup init --no-base

up:             ## Start Compose stack
	docker-compose -f ${COMPOSE} up -d --build
	docker-compose -f ${COMPOSE} logs -f

up_db:
	docker-compose -f ${COMPOSE} up -d --build db db_reserves hasura hasura_reserves

down:           ## Stop Compose stack
	docker-compose -f ${COMPOSE} down

##